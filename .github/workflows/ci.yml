name: CI

on:
  pull_request:
    branches: [ main ]

jobs:
  functional-tests:
    name: Functional Tests
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
    
    - name: Start native SSH test server
      run: |
        set -euxo pipefail

        # Create test user with password
        sudo sysadminctl -addUser myuser -password mypass

        # Ensure user shell and home directory
        sudo dscl . -create /Users/myuser UserShell /bin/bash
        sudo createhomedir -c -u myuser

        # Allow SSH via PAM access group
        sudo dseditgroup -o edit -a myuser -t user com.apple.access_ssh

        # Set up authorized_keys with repo public key
        sudo mkdir -p /Users/myuser/.ssh
        sudo cp Tests/Data/id_ed25519.pub /Users/myuser/.ssh/authorized_keys
        sudo chown -R myuser:staff /Users/myuser/.ssh
        sudo chmod 700 /Users/myuser/.ssh
        sudo chmod 600 /Users/myuser/.ssh/authorized_keys
        sudo chmod 600 Tests/Data/id_ed25519
        
        # Generate host keys and start sshd on port 2222
        sudo ssh-keygen -A
        sudo /usr/sbin/sshd -p 2222 \
          -o PasswordAuthentication=yes \
          -o PubkeyAuthentication=yes \
          -o AuthorizedKeysFile=.ssh/authorized_keys \
          -E /tmp/sshd.log
        
        # Wait for sshd to be ready
        for i in $(seq 1 20); do
          nc -z 127.0.0.1 2222 && break
          sleep 1
        done

        if ! ssh -p 2222 -i Tests/Data/id_ed25519 \
            -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
            myuser@localhost true; then
          echo "sshd failed to start or auth failed"
          echo "==== sshd.log ===="
          sudo cat /tmp/sshd.log || true
          exit 1
        fi

        echo "SSH Server is Up"

    - name: Run tests
      run: swift test
